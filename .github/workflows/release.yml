name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true

jobs:
  build:
    name: Build ${{ matrix.platform }}
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x64
          - os: ubuntu-22.04
            platform: linux-x64
            binary_name: unipm
            output_name: unipm-linux-x64
            
          # macOS Intel
          - os: macos-13
            platform: macos-x64
            binary_name: unipm
            output_name: unipm-macos-x64
            
          # macOS ARM64 (Apple Silicon)
          - os: macos-14
            platform: macos-arm64
            binary_name: unipm
            output_name: unipm-macos-arm64
            
          # Windows x64
          - os: windows-latest
            platform: windows-x64
            binary_name: unipm.exe
            output_name: unipm-windows-x64.exe
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup CMake
        uses: lukka/get-cmake@latest
      
      - name: Install dependencies (Linux)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential
      
      - name: Install dependencies (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install cmake
      
      - name: Configure CMake
        run: |
          cmake -B build -DCMAKE_BUILD_TYPE=Release
      
      - name: Build
        run: |
          cmake --build build --config Release -j$(nproc 2>/dev/null || sysctl -n hw.ncpu 2>/dev/null || echo 2)
      
      - name: Run tests
        run: |
          cd build
          ctest -C Release --output-on-failure
      
      - name: Prepare binary (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist
          cp build/bin/${{ matrix.binary_name }} dist/${{ matrix.output_name }}
          chmod +x dist/${{ matrix.output_name }}
      
      - name: Prepare binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path dist
          Copy-Item build\bin\Release\${{ matrix.binary_name }} dist\${{ matrix.output_name }}
      
      - name: Generate checksum (Unix)
        if: runner.os != 'Windows'
        run: |
          cd dist
          sha256sum ${{ matrix.output_name }} > ${{ matrix.output_name }}.sha256
          cat ${{ matrix.output_name }}.sha256
      
      - name: Generate checksum (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          cd dist
          $hash = (Get-FileHash -Path "${{ matrix.output_name }}" -Algorithm SHA256).Hash.ToLower()
          "$hash  ${{ matrix.output_name }}" | Out-File -FilePath "${{ matrix.output_name }}.sha256" -Encoding ASCII
          Get-Content "${{ matrix.output_name }}.sha256"
      
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}
          path: |
            dist/${{ matrix.output_name }}
            dist/${{ matrix.output_name }}.sha256
          retention-days: 7
  
  create-release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Display structure
        run: ls -R artifacts
      
      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          find artifacts -type f \( -name "unipm-*" -o -name "*.sha256" \) -exec cp {} release-assets/ \;
          ls -lh release-assets/
      
      - name: Extract version from tag
        id: get_version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            VERSION=${GITHUB_REF#refs/tags/v}
            echo "version=$VERSION" >> $GITHUB_OUTPUT
          fi
      
      - name: Generate release notes
        id: release_notes
        run: |
          cat > release-notes.md << EOF
          ## unipm v${{ steps.get_version.outputs.version }}
          
          ### Installation
          
          **Linux/macOS:**
          \`\`\`bash
          curl -fsSL https://raw.githubusercontent.com/ieee-cs-bmsit/unipm/main/scripts/install.sh | bash
          \`\`\`
          
          **Windows (PowerShell):**
          \`\`\`powershell
          iwr -useb https://raw.githubusercontent.com/ieee-cs-bmsit/unipm/main/scripts/install.ps1 | iex
          \`\`\`
          
          ### Direct Downloads
          
          | Platform | Binary | SHA256 |
          |----------|--------|--------|
          | Linux x64 | [unipm-linux-x64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/unipm-linux-x64) | [checksum](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/unipm-linux-x64.sha256) |
          | macOS Intel | [unipm-macos-x64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/unipm-macos-x64) | [checksum](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/unipm-macos-x64.sha256) |
          | macOS ARM64 | [unipm-macos-arm64](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/unipm-macos-arm64) | [checksum](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/unipm-macos-arm64.sha256) |
          | Windows x64 | [unipm-windows-x64.exe](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/unipm-windows-x64.exe) | [checksum](https://github.com/${{ github.repository }}/releases/download/v${{ steps.get_version.outputs.version }}/unipm-windows-x64.exe.sha256) |
          
          ### Verify Installation
          
          \`\`\`bash
          unipm --version
          unipm help
          \`\`\`
          
          ### What's Changed
          
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for full details.
          
          ### Documentation
          
          - [README](https://github.com/${{ github.repository }}/blob/main/README.md)
          - [Architecture](https://github.com/${{ github.repository }}/blob/main/docs/ARCHITECTURE.md)
          - [Contributing](https://github.com/${{ github.repository }}/blob/main/.github/CONTRIBUTING.md)
          EOF
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.version }}
          name: unipm v${{ steps.get_version.outputs.version }}
          body_path: release-notes.md
          files: release-assets/*
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload to latest release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: latest
          name: Latest Build
          body: "This is the latest development build. For stable releases, see numbered versions."
          files: release-assets/*
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
